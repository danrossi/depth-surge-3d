<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Depth Surge 3D - 2D to Immersive 3D VR Converter</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Terminal Precision theme */
        :root {
            --bs-body-bg: #0a0a0a;
            --bs-body-color: #e0e0e0;
            --bs-card-bg: #111111;
            --bs-border-color: #1a1a1a;
            --bs-input-bg: #0f0f0f;
            --bs-input-color: #e0e0e0;
            --bs-input-border-color: #2a2a2a;
            --accent-lime: #39ff14;
            --accent-green: #00ff41;
        }
        
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 16px, rgba(255, 255, 255, 0.08) 16px, rgba(255, 255, 255, 0.08) 17px),
                repeating-linear-gradient(90deg, transparent, transparent 16px, rgba(255, 255, 255, 0.08) 16px, rgba(255, 255, 255, 0.08) 17px);
            pointer-events: none;
            z-index: 0;
            opacity: 1;
        }


        .container-fluid {
            position: relative;
            z-index: 1;
        }
        
        .card {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }
        
        .form-control, .form-select {
            background-color: var(--bs-input-bg);
            color: var(--bs-input-color);
            border-color: var(--bs-input-border-color);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bs-input-bg);
            color: var(--bs-input-color);
            border-color: var(--accent-lime);
            box-shadow: 0 0 0 0.25rem rgba(57, 255, 20, 0.15);
        }
        
        /* File input styling for dark theme */
        .form-control[type="file"] {
            background-color: var(--bs-input-bg);
            color: var(--bs-input-color);
            border-color: var(--bs-input-border-color);
        }
        
        .form-control[type="file"]:focus {
            background-color: var(--bs-input-bg);
            color: var(--bs-input-color);
            border-color: var(--accent-lime);
            box-shadow: 0 0 0 0.25rem rgba(57, 255, 20, 0.15);
        }
        
        /* File input button styling */
        .form-control[type="file"]::file-selector-button {
            background-color: #495057;
            color: var(--bs-input-color);
            border: 1px solid var(--bs-input-border-color);
            border-radius: 0;
            padding: 0.375rem 0.75rem;
            margin-right: 0.75rem;
            cursor: pointer;
        }
        
        .form-control[type="file"]::file-selector-button:hover {
            background-color: #5a6268;
        }
        
        .alert-info {
            background-color: #0c4a6e;
            border-color: #075985;
            color: #bfdbfe;
        }
        
        .video-preview {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 0;
        }
        
        .preview-images {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .preview-item {
            text-align: center;
        }
        
        .preview-images img {
            width: 240px;
            height: 180px;
            object-fit: cover;
            border: 1px solid var(--bs-border-color);
            border-radius: 0;
            background: #000;
        }
        
        .preview-images .preview-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .progress-container {
            display: none;
        }
        
        .time-input {
            width: 120px;
        }
        
        .video-info, .system-info {
            background: var(--bs-card-bg);
            border: 1px solid var(--bs-border-color);
            padding: 10px;
            border-radius: 0;
            margin: 10px 0;
        }

        .settings-panel {
            background: var(--bs-card-bg);
            border: 1px solid var(--bs-border-color);
            padding: 15px;
            border-radius: 0;
            margin: 15px 0;
        }

        /* Pipeline Step Styles */
        .pipeline-step {
            background: var(--bs-card-bg);
            border-left: 3px solid var(--accent-lime);
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }

        .pipeline-step.active {
            border-left-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        .pipeline-step.completed {
            border-left-color: #2a2a2a;
            opacity: 0.7;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            background: var(--accent-lime);
            color: #000;
            font-weight: bold;
            border-radius: 50%;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .step-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-lime);
            margin: 0;
        }

        .step-indicator {
            font-size: 0.85rem;
            color: var(--accent-lime);
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(57, 255, 20, 0.1);
            border-left: 2px solid var(--accent-lime);
            font-family: 'Courier New', monospace;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 3px 0;
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #adb5bd;
        }
        
        .info-value {
            color: var(--bs-body-color);
        }
        
        .progress-section {
            margin: 15px 0;
        }
        
        .sub-progress {
            height: 8px;
            margin: 8px 0;
        }
        
        .frame-update-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 0;
            font-size: 0.8em;
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 0;
            text-align: center;
            border: 1px solid var(--bs-border-color);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-lime);
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #adb5bd;
        }
        
        .text-muted {
            color: #6c757d !important;
        }

        /* Code element styling - use white instead of rose */
        code {
            color: #e0e0e0 !important;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        /* Progress bar color overrides - Terminal Precision theme */
        .progress-bar.bg-success {
            background-color: var(--accent-lime) !important;
            background-image: linear-gradient(45deg, var(--accent-lime) 0%, var(--accent-green) 100%);
        }

        .progress-bar.bg-info {
            background-color: #00d9ff !important;
            background-image: linear-gradient(45deg, #00d9ff 0%, #00aaff 100%);
        }

        /* Progress animations */
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        
        /* Flat buttons - Terminal Precision */
        .btn-primary {
            background: radial-gradient(circle at center, var(--accent-lime), var(--accent-green));
            border: 2px solid var(--accent-lime);
            color: #000;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow:
                0 0 20px rgba(57, 255, 20, 0.4),
                0 0 40px rgba(57, 255, 20, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover {
            background: radial-gradient(circle at center, #4dff28, var(--accent-lime));
            border-color: #4dff28;
            color: #000;
            box-shadow:
                0 0 30px rgba(57, 255, 20, 0.6),
                0 0 60px rgba(57, 255, 20, 0.3),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: radial-gradient(circle at center, var(--accent-lime), var(--accent-green));
            border: 2px solid var(--accent-lime);
            color: #000;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow:
                0 0 20px rgba(57, 255, 20, 0.4),
                0 0 40px rgba(57, 255, 20, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .btn-success:disabled {
            background: #000;
            border: 1px solid #333;
            color: #555;
            font-weight: 400;
            box-shadow: none;
            text-shadow: none;
            opacity: 1;
            cursor: not-allowed;
        }

        .btn-success:hover:not(:disabled) {
            background: radial-gradient(circle at center, #4dff28, var(--accent-lime));
            border-color: #4dff28;
            color: #000;
            box-shadow:
                0 0 30px rgba(57, 255, 20, 0.6),
                0 0 60px rgba(57, 255, 20, 0.3),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-success:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #000;
            border: 1px solid #666;
            color: #999;
        }

        .btn-secondary:hover {
            background: #1a1a1a;
            border-color: #999;
            color: #ccc;
        }

        .btn-outline-secondary {
            background: transparent;
            border: 1px solid #333;
            color: #999;
        }

        .btn-outline-secondary:hover {
            background: #1a1a1a;
            border-color: #666;
            color: #ccc;
        }

        .btn-outline-success {
            background: transparent;
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .btn-outline-success:hover {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        .btn-outline-primary {
            background: transparent;
            border: 1px solid var(--accent-lime);
            color: var(--accent-lime);
        }

        .btn-outline-primary:hover {
            background: var(--accent-lime);
            border-color: var(--accent-lime);
            color: #000;
        }

        .btn-outline-warning {
            background: transparent;
            border: 1px solid #888;
            color: #888;
        }

        .btn-outline-warning:hover {
            background: #888;
            border-color: #888;
            color: #000;
        }

        .btn-danger {
            background: #000;
            border: 1px solid #cc0000;
            color: #ff3333;
        }

        .btn-danger:hover {
            background: #cc0000;
            border-color: #cc0000;
            color: #000;
        }

        .btn-group .btn {
            border-radius: 0;
        }
        
        /* Compact styling for desktop */
        .container-fluid {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .card {
            margin-bottom: 0.75rem;
        }

        .card-body {
            padding: 0.75rem;
        }

        .card-header {
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
        }

        .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        .mt-3, .my-3 {
            margin-top: 0.75rem !important;
        }

        h5 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        h6 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .form-label {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .form-control, .form-select {
            padding: 0.375rem 0.5rem;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
        }

        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }

        small, .small {
            font-size: 0.8rem;
        }
        
        /* Flat tab styling - Terminal Precision */
        .nav-tabs {
            border-bottom: 1px solid var(--bs-border-color);
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-link {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #666;
            border-radius: 0;
            margin-right: 0;
            padding: 10px 18px;
            font-weight: 400;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link:hover {
            background: transparent;
            border-bottom-color: #444;
            color: #999;
        }

        .nav-tabs .nav-link.active {
            background: transparent;
            border-bottom-color: var(--accent-lime);
            color: var(--accent-lime);
            box-shadow: none;
        }

        .nav-tabs .nav-link i {
            margin-right: 6px;
        }
    </style>
</head>
<body style="padding-top: 0;">
    <div class="container-fluid" style="margin-top: 0.5rem;">
        <div class="row">
            <div class="col-12">
                <div class="text-end mb-2">
                    <small class="text-muted">
                        <a href="https://github.com/tok/depth-surge-3d" target="_blank" class="text-decoration-none text-muted">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 4px;">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            github.com/tok/depth-surge-3d
                        </a>
                    </small>
                </div>
                <h1 class="text-center mb-2" style="position: relative; margin-top: -0.5rem;">
                    <span style="
                        font-weight: 900;
                        font-size: 3rem;
                        letter-spacing: 3px;
                        color: #000;
                        text-shadow:
                            0 0 10px rgba(255, 255, 255, 0.8),
                            0 0 20px rgba(255, 255, 255, 0.6),
                            0 0 30px rgba(255, 255, 255, 0.4),
                            0 0 40px rgba(255, 255, 255, 0.2);
                        -webkit-text-stroke: 1.5px rgba(255, 255, 255, 0.5);
                    ">
                        DEPTH SURGE 3D
                    </span>
                </h1>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="processing-tab" data-bs-toggle="tab" data-bs-target="#processing" type="button" role="tab">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            Processing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="stitching-tab" data-bs-toggle="tab" data-bs-target="#stitching" type="button" role="tab">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                                <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                                <line x1="7" y1="2" x2="7" y2="22"/>
                                <line x1="17" y1="2" x2="17" y2="22"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <line x1="2" y1="7" x2="7" y2="7"/>
                                <line x1="2" y1="17" x2="7" y2="17"/>
                                <line x1="17" y1="7" x2="22" y2="7"/>
                                <line x1="17" y1="17" x2="22" y2="17"/>
                            </svg>
                            Video Stitching
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Processing Tab Content -->
            <div class="tab-pane fade show active" id="processing" role="tabpanel">
        
        <!-- Video Upload Section -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Upload Video</h5>
                    </div>
                    <div class="card-body">
                        <label for="videoFile" class="btn btn-success w-100" id="uploadBtn" style="cursor: pointer;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span id="uploadBtnText">Upload Video</span>
                        </label>
                        <input type="file" class="form-control d-none" id="videoFile" accept="video/*">
                        
                        <!-- Video Preview -->
                        <div id="videoPreview" style="display: none;" class="mt-3">
                            <video class="video-preview" controls>
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        
                        <!-- Video Info -->
                        <div id="videoInfo" class="video-info" style="display: none;">
                            <h6><i class="fas fa-info-circle"></i> Video Information</h6>
                            <div class="info-row">
                                <span class="info-label">Resolution:</span>
                                <span class="info-value" id="videoResolution"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Source FPS:</span>
                                <span class="info-value" id="videoFps"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Aspect Ratio:</span>
                                <span class="info-value" id="videoAspect"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Duration:</span>
                                <span class="info-value" id="videoDuration"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Frame Count:</span>
                                <span class="info-value" id="videoFrames"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resume Processing and System Info -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play"></i> Resume Processing</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="resumeDirectory" class="form-label">Output Directory to Resume</label>
                            <input type="text" class="form-control" id="resumeDirectory" 
                                   placeholder="e.g., output/video_name_20231215_143022">
                        </div>
                        <button type="button" class="btn btn-secondary" id="resumeBtn">
                            <i class="fas fa-play"></i> Resume Processing
                        </button>
                        <small class="form-text text-muted mt-2">
                            Resumes an interrupted processing job from the output directory timestamp.
                        </small>
                    </div>
                </div>
                
                <!-- System Information -->
                <div class="system-info">
                    <h6><i class="fas fa-desktop"></i> System Information</h6>
                    <div class="system-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="gpuDevice">--</div>
                            <div class="stat-label">GPU Device</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="vramUsage">--</div>
                            <div class="stat-label">VRAM Usage</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="deviceMode">--</div>
                            <div class="stat-label">Processing Mode</div>
                        </div>
                    </div>
                </div>

                <!-- Time Range Selection -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Time Range Selection</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Start Time (mm:ss or hh:mm:ss)</label>
                            <div class="input-group">
                                <input type="text" class="form-control time-input" id="startTime" placeholder="00:00" value="">
                                <button class="btn btn-outline-secondary" type="button" id="resetStartTime" title="Reset to 00:00">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Time (mm:ss or hh:mm:ss)</label>
                            <div class="input-group">
                                <input type="text" class="form-control time-input" id="endTime" placeholder="00:30" value="">
                                <button class="btn btn-outline-secondary" type="button" id="resetEndTime" title="Reset to video end">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>

                        <!-- Range Info -->
                        <div id="rangeInfo" class="alert alert-info" style="display: none;">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Duration:</strong> <span id="rangeDuration">--</span>
                                </div>
                                <div class="col-6">
                                    <strong>Est. Frames:</strong> <span id="rangeFrames">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="row">
            <div class="col-12">
                <div class="settings-panel">
                    <h5><i class="fas fa-cog"></i> Processing Settings</h5>

                    <!-- Step 1: Input & Frame Extraction -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <h6 class="step-title">Input & Frame Extraction</h6>
                        </div>

                        <!-- Source video info display -->
                        <div class="alert alert-info" id="step1SourceInfo" style="display: none;">
                            <strong>Source Video:</strong> <span id="step1SourceRes">--</span> @ <span id="step1SourceFps">--</span> fps
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Frame Rescaling <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Fast FFmpeg rescaling (not AI upscaling). Use to downscale 4K→1080p for speed, or upscale 720p→1080p to compensate for quality loss in side-by-side VR format."></i></label>
                            <select class="form-select" id="resolution">
                                <option value="original" selected>Keep Original Resolution</option>
                                <option value="720p">Rescale to 720p (1280×720)</option>
                                <option value="1080p">Rescale to 1080p (1920×1080)</option>
                                <option value="4k">Rescale to 4K (3840×2160)</option>
                            </select>
                            <small class="form-text text-muted"><i class="fas fa-tachometer-alt"></i> Uses fast FFmpeg Lanczos scaling (not AI upscaling, won't alter visual style)</small>
                        </div>
                        <div class="mb-3" style="display: none;">
                            <label class="form-label">Super Sampling</label>
                            <select class="form-select" id="superSample">
                                <option value="none" selected>None (Keep Original)</option>
                                <option value="1080p">Force 1080p</option>
                                <option value="4k">Force 4K</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target FPS <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Frame rate for processing. Higher FPS = smoother motion but longer processing time."></i></label>
                            <select class="form-select" id="targetFps">
                                <option value="original" selected>Keep Original FPS</option>
                                <option value="30">30 FPS</option>
                                <option value="60">60 FPS</option>
                                <option value="120">120 FPS</option>
                            </select>
                        </div>
                        <div class="step-indicator" id="step1Indicator">
                            <strong>After extraction:</strong> <span id="step1FinalRes">--</span> @ <span id="step1FinalFps">--</span> fps
                        </div>
                    </div>

                    <!-- Step 2: Depth Analysis -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <h6 class="step-title">Depth Analysis</h6>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depth Model Version <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="V3: Lower VRAM (~50% less), faster, newer architecture (default). V2: Better temporal consistency (smoother), higher VRAM."></i></label>
                            <select class="form-select" id="depthModelVersion">
                                <option value="v3" selected>Depth-Anything V3 (Default, Lower VRAM, Faster)</option>
                                <option value="v2">Video-Depth-Anything V2 (Temporal Consistency)</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-film"></i> V2: 32-frame temporal windows for smooth depth<br>
                                <i class="fas fa-bolt"></i> V3: Frame-by-frame, ~50% less VRAM, optional xformers optimization
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depth Model Size <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Smaller models use less VRAM but may be slightly less accurate. Use Small if you have OOM errors."></i></label>
                            <select class="form-select" id="modelSize">
                                <option value="vitb" selected>Base (Balanced, ~8GB VRAM) - Recommended</option>
                                <option value="vits">Small (Fast, ~4GB VRAM)</option>
                                <option value="vitl">Large (Best Quality, ~12GB VRAM)</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-memory"></i> Base model recommended for 16GB GPUs<br>
                                <i class="fas fa-info-circle"></i> Use Small for 8GB GPUs or high-res videos
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depth Map Resolution <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Higher resolution = better quality depth maps but slower processing and more VRAM. Auto matches your video resolution (recommended)."></i></label>
                            <select class="form-select" id="depthResolution">
                                <option value="auto" selected>Auto (Match Source Resolution)</option>
                                <option value="518">SD - 518px (Fast, Low VRAM)</option>
                                <option value="720">HD - 720px (Balanced)</option>
                                <option value="1080">Full HD - 1080px (High Quality)</option>
                                <option value="1440">2K - 1440px (Only if upscaling frames)</option>
                                <option value="2160">4K - 2160px (Only for 4K source)</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-layer-group"></i> Auto: Matches your video's actual resolution<br>
                                <i class="fas fa-exclamation-triangle"></i> Don't exceed source resolution (wastes VRAM)
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depth Model Type <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Metric models provide actual depth in meters (better for VR). Relative models only provide depth ordering."></i></label>
                            <select class="form-select" id="depthModelType">
                                <option value="metric" selected>Metric Depth (Accurate meters, best for VR)</option>
                                <option value="relative">Relative Depth (Ordering only, faster)</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-ruler"></i> Metric depth recommended for better 3D quality<br>
                                <i class="fas fa-brain"></i> Trained on Virtual KITTI and IRS datasets
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Processing Device</label>
                            <select class="form-select" id="device">
                                <option value="auto" selected>Auto (GPU if available)</option>
                                <option value="cuda">Force GPU (CUDA)</option>
                                <option value="cpu">Force CPU</option>
                            </select>
                        </div>
                        <small class="form-text text-muted">
    <i class="fas fa-cube"></i> Video-Depth-Anything processes in 32-frame chunks with temporal consistency<br>
    <i class="fas fa-link"></i> <a href="https://github.com/DepthAnything/Depth-Anything-V2" target="_blank" style="color: var(--accent-lime);">Model Info & Documentation</a>
</small>
                    </div>

                    <!-- Step 2.5: Motion Compensation (Optical Flow) -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">2.5</span>
                            <h6 class="step-title">Motion Compensation (Optional)</h6>
                        </div>
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="enableOpticalFlow">
                                <label class="form-check-label" for="enableOpticalFlow">
                                    <strong>Enable Optical Flow Motion Compensation</strong>
                                </label>
                                <small class="text-muted d-block ms-4">
                                    <i class="fas fa-chart-line"></i> Improves temporal consistency using motion analysis between frames<br>
                                    <i class="fas fa-clock"></i> Processing overhead: +10-20% time, +2-4GB VRAM
                                </small>
                            </div>

                            <div id="opticalFlowSettings" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Flow Model <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Auto tries UniMatch first (MIT license, best quality), falls back to RAFT (PyTorch built-in). Both analyze motion between frames to improve depth consistency."></i></label>
                                    <select class="form-select" id="opticalFlowModel">
                                        <option value="auto" selected>Auto (UniMatch → RAFT fallback)</option>
                                        <option value="unimatch">UniMatch (Best quality, MIT)</option>
                                        <option value="raft">RAFT-Large (PyTorch built-in)</option>
                                        <option value="raft_small">RAFT-Small (Fastest)</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-robot"></i> UniMatch: Newer unified model (better quality)<br>
                                        <i class="fas fa-bolt"></i> RAFT: Recurrent all-pairs field transforms
                                    </small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Blend Weight: <span id="opticalFlowBlendValue">50%</span> <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Controls how much to blend the motion-compensated depth with the original. 0% = original only (no compensation), 50% = balanced, 100% = fully compensated."></i></label>
                                    <input type="range" class="form-range" id="opticalFlowBlend"
                                           min="0" max="100" step="5" value="50">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-arrow-left"></i> <strong>0%</strong> = Original depth only |
                                        <strong>50%</strong> = Balanced (default) |
                                        <strong>100%</strong> = Fully compensated <i class="fas fa-arrow-right"></i>
                                    </small>
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="opticalFlowDetectOcclusions">
                                    <label class="form-check-label" for="opticalFlowDetectOcclusions">
                                        Detect Occlusions (Forward-Backward Consistency)
                                    </label>
                                    <small class="text-muted d-block ms-4">
                                        <i class="fas fa-eye"></i> More accurate handling of occluded regions, but slower
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="step-indicator">Warps previous depth using optical flow for smoother transitions</div>
                    </div>

                    <!-- Step 3: Stereo Pair Generation -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">3</span>
                            <h6 class="step-title">Stereo Pair Generation</h6>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Stereo Baseline <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Controls 3D strength. Larger = stronger 3D effect but more artifacts. Start with 0.035-0.05 for subtle, clean results."></i></label>
                            <input type="number" class="form-control" id="baseline" value="0.065" step="0.005" min="0.02" max="0.15">
                            <small class="form-text text-muted">Distance between virtual cameras in meters (0.02-0.15, default: 0.065 = average human IPD)
                            <br><strong>Tip:</strong> Reduce to 0.035-0.05 if you see artifacts or warping</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Focal Length <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Works with baseline to control depth perception. Higher = stronger depth separation. Lower = gentler transitions."></i></label>
                            <input type="number" class="form-control" id="focalLength" value="1000" step="50" min="500" max="2000">
                            <small class="form-text text-muted">Virtual camera focal length (500-2000px, default: 1000)
                            <br><strong>Conservative:</strong> 700-800 | <strong>Aggressive:</strong> 1200-1500</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">3D Strength Presets</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="set3DPreset('subtle')">Subtle & Clean</button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="set3DPreset('balanced')">Balanced</button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="set3DPreset('strong')">Strong & Dirty</button>
                            </div>
                            <small class="form-text text-muted">Quick presets for common use cases</small>
                        </div>
                        <div class="step-indicator">Preview showing [L][R] disparity</div>
                    </div>

                    <!-- Step 4: VR Lens Simulation -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">4</span>
                            <h6 class="step-title">Fisheye Distortion</h6>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyDistortion" checked>
                                <label class="form-check-label" for="applyDistortion">
                                    Enable Fisheye Processing
                                </label>
                            </div>
                            <small class="form-text text-muted">Enable fisheye distortion for hemispherical VR projection</small>
                        </div>
                        <div class="mb-3" id="distortionOptions">
                            <label class="form-label">Fisheye Projection</label>
                            <select class="form-select" id="fisheyeProjection">
                                <option value="equidistant">Equidistant (f*θ)</option>
                                <option value="stereographic" selected>Stereographic (2f*tan(θ/2))</option>
                                <option value="equisolid">Equisolid Angle (2f*sin(θ/2))</option>
                                <option value="orthographic">Orthographic (f*sin(θ))</option>
                            </select>
                            <small class="form-text text-muted">Mathematical projection model for fisheye lens</small>
                        </div>
                        <div class="mb-3" id="distortionK2Options">
                            <label class="form-label">Field of View (degrees)</label>
                            <input type="number" class="form-control" id="fisheyeFov" value="180" step="5" min="75" max="180">
                            <small class="form-text text-muted">Fisheye field of view (75-180 degrees, default: 180 for full dome)</small>
                        </div>
                        <div class="step-indicator">FOV: 180° → hemispherical projection</div>
                    </div>

                    <!-- Step 5: Final Processing -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">5</span>
                            <h6 class="step-title">Final Processing</h6>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Crop Factor (Standard) <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Applied when fisheye is disabled. Crops from center to remove stereo edge artifacts. 1.0 = no crop, 0.5 = keep center 50%."></i></label>
                            <input type="number" class="form-control" id="cropFactor" value="1.0" step="0.05" min="0.5" max="1.0">
                            <small class="form-text text-muted">
    <i class="fas fa-crop"></i> Removes edge artifacts from stereo generation (rectangular crop from center)<br>
    <strong>1.0</strong> = no crop | <strong>0.8</strong> = keep center 80% | <strong>0.5</strong> = keep center 50%
</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fisheye Crop Factor <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Applied when fisheye is enabled. Controls zoom level of the fisheye projection. <1.0 zooms in to hide curved edges, >1.0 shows more field of view."></i></label>
                            <input type="number" class="form-control" id="fisheyeCropFactor" value="0.7" step="0.05" min="0.5" max="2.0">
                            <small class="form-text text-muted">
    <i class="fas fa-search-plus"></i> Zoom/crop for fisheye projection (hemispherical to fit VR display)<br>
    <strong>0.5</strong> = zoomed in (hides edges) | <strong>0.7</strong> = balanced (default) | <strong>1.0</strong> = full circle | <strong>>1.0</strong> = show more FOV
</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hole Filling Quality <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Advanced uses depth-guided multi-stage filling for better quality but slower processing. Fast uses simple inpainting for speed."></i></label>
                            <select class="form-select" id="holeFillQuality">
                                <option value="fast" selected>Fast (Simple Inpainting)</option>
                                <option value="advanced">Advanced (Multi-Stage + Depth Guidance)</option>
                            </select>
                            <small class="form-text text-muted">Balance between processing speed and stereo quality
                            <br><strong>Warning:</strong> Advanced is 3-5x slower with often minimal visual improvement</small>
                        </div>
                        <div class="step-indicator">Cropping removes edge artifacts from stereo generation</div>
                    </div>

                    <!-- Step 6: VR Format & Output -->
                    <div class="pipeline-step">
                        <div class="step-header">
                            <span class="step-number">6</span>
                            <h6 class="step-title">VR Format & Output</h6>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">VR Format <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Side-by-Side (SBS): Most common. Left and right views placed horizontally. Final output is 2× width (e.g., 1920×1080 per eye → 3840×1080 total). Over-Under: Stacked vertically. Better for ultra-wide/cinema. Final output is 2× height."></i></label>
                            <select class="form-select" id="vrFormat">
                                <option value="side_by_side" selected>Side by Side (SBS)</option>
                                <option value="side_by_side_lr">Side by Side LR (Left-Right)</option>
                                <option value="side_by_side_rl">Side by Side RL (Right-Left)</option>
                                <option value="over_under">Over Under (Top-Bottom)</option>
                                <option value="over_under_lr">Over Under LR (Left-Top)</option>
                                <option value="over_under_rl">Over Under RL (Right-Top)</option>
                            </select>
                            <small class="form-text text-muted">Choose format compatible with your VR headset</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">VR Resolution per Eye <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Square formats (1:1): Optimized for VR headsets. Example: 1080×1080 per eye = 2160×1080 total (SBS) or 1080×2160 (Over-Under). 16:9 formats: Standard widescreen, preserves original content aspect ratio naturally."></i></label>
                            <select class="form-select" id="vrResolution">
                                <option value="auto" selected>Auto (Match Source Quality & Aspect)</option>
                                <optgroup label="Square Formats (VR Optimized)">
                                                                    <option value="square-480">Square 480 (480×480 per eye - Quick Test Only ⚠️)</option>
                            <option value="square-720">Square 720 (720×720 per eye - Preview Quality ⚠️)</option>
                                    <option value="square-1k">Square 1K (1080×1080 per eye)</option>
                                    <option value="square-2k">Square 2K (1536×1536 per eye)</option>
                                    <option value="square-3k">Square 3K (1920×1920 per eye)</option>
                                    <option value="square-4k">Square 4K (2048×2048 per eye)</option>
                                    <option value="square-5k">Square 5K (2560×2560 per eye)</option>
                                </optgroup>
                                <optgroup label="16:9 Formats (Standard Wide)">
                                                                    <option value="16x9-480p">16:9 480p (854×480 per eye - Quick Test Only ⚠️)</option>
                            <option value="16x9-720p">16:9 720p (1280×720 per eye - Preview Quality ⚠️)</option>
                                    <option value="16x9-1080p">16:9 1080p (1920×1080 per eye)</option>
                                    <option value="16x9-1440p">16:9 1440p (2560×1440 per eye)</option>
                                    <option value="16x9-4k">16:9 4K (3840×2160 per eye)</option>
                                    <option value="16x9-5k">16:9 5K (5120×2880 per eye)</option>
                                    <option value="16x9-8k">16:9 8K (7680×4320 per eye)</option>
                                </optgroup>
                                <optgroup label="Legacy Wide Formats">
                                    <option value="wide-2k">Wide 2K (2560×1440 per eye)</option>
                                    <option value="wide-4k">Wide 4K (3840×2160 per eye)</option>
                                    <option value="ultrawide">Ultra-wide (3840×2160 per eye)</option>
                                </optgroup>
                                <optgroup label="Cinema Formats (Ultra-wide, recommend over-under)">
                                    <option value="cinema-2k">Cinema 2K (2048×858 per eye)</option>
                                    <option value="cinema-4k">Cinema 4K (4096×1716 per eye)</option>
                                </optgroup>
                                <optgroup label="Custom Resolution">
                                    <option value="custom">Custom (specify below)</option>
                                </optgroup>
                            </select>
                            <small class="form-text text-muted">Resolution shown is per eye. Total output depends on VR format (SBS doubles width, Over-Under doubles height).</small>
                        </div>
                        <div class="mb-3" id="customResolutionDiv" style="display: none;">
                            <label class="form-label">Custom Resolution (per eye)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="customWidth" placeholder="Width" min="480" max="7680" step="1">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" id="customHeight" placeholder="Height" min="270" max="4320" step="1">
                                </div>
                            </div>
                            <small class="form-text text-muted">Specify custom width × height per eye (e.g., 1920 × 1080)</small>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="preserveAudio" checked>
                            <label class="form-check-label" for="preserveAudio">
                                Preserve Audio
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="keepIntermediates" checked>
                            <label class="form-check-label" for="keepIntermediates">
                                Keep Intermediate Files
                            </label>
                            <small class="text-muted d-block ms-4">
                                <i class="fas fa-exclamation-triangle"></i> May use significant disk space (~10-50GB for long videos)
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Video Encoder <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="Auto detects NVENC (NVIDIA GPU) and falls back to software. Software encoding is slower but works on all systems."></i></label>
                            <select class="form-select" id="videoEncoder">
                                <option value="auto" selected>Auto (Try NVENC, fallback to H.264)</option>
                                <option value="nvenc">NVENC H.265 (NVIDIA GPU Only)</option>
                                <option value="libx264">Software H.264 (Compatible, Slower)</option>
                                <option value="libx265">Software H.265 (Best Quality, Slowest)</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-microchip"></i> NVENC: ~10x faster on NVIDIA GPUs<br>
                                <i class="fas fa-server"></i> Software: Works everywhere, CPU-intensive
                            </small>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="experimentalFrameInterpolation">
                            <label class="form-check-label" for="experimentalFrameInterpolation">
                                Frame Interpolation (Double FPS)
                            </label>
                            <small class="text-muted d-block ms-4">
                                <i class="fas fa-flask"></i> Experimental: Applies FFmpeg minterpolate to final VR video output<br>
                                <i class="fas fa-info-circle"></i> Not AI-based, won't alter visual style. May show motion artifacts.
                            </small>
                        </div>

                        <div class="step-indicator">Final output: Calculated at runtime</div>
                    </div>



                    <!-- Process Button -->
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-success btn-lg" id="processBtn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            Start Processing
                        </button>
                        <button type="button" class="btn btn-danger btn-lg ms-2" id="stopBtn" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                            Stop Processing
                        </button>
                        <br>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="resetSettingsBtn">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <polyline points="1 4 1 10 7 10"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="row">
            <div class="col-12">
                <div class="progress-container">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-spinner fa-spin"></i> Processing Progress</h5>
                        </div>
                        <div class="card-body">
                            <!-- Overall Progress -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Overall Progress</strong>
                                    <span id="overallProgressText">0%</span>
                                </div>
                                <div class="progress" style="height: 24px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                         role="progressbar"
                                         id="overallProgressBar"
                                         style="width: 0%;"
                                         aria-valuenow="0"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        <span id="overallProgressPhase">Initializing...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Step Progress Bars -->
                            <div class="mb-3">
                                <small class="text-muted d-block mb-2"><strong>Processing Steps</strong></small>

                                <!-- Step 1: Frame Extraction -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-film"></i> 1. Extract Frames</span>
                                        <span id="step1Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step1Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 2: Depth Maps -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-layer-group"></i> 2. Generate Depth Maps</span>
                                        <span id="step2Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step2Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 3: Load Frames -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-image"></i> 3. Load Frames</span>
                                        <span id="step3Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step3Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 4: Stereo Pairs -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-glasses"></i> 4. Create Stereo Pairs</span>
                                        <span id="step4Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step4Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 5: Fisheye Distortion -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-circle-notch"></i> 5. Apply Distortion</span>
                                        <span id="step5Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step5Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 6: VR Frames -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-vr-cardboard"></i> 6. Create VR Frames</span>
                                        <span id="step6Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step6Bar" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <!-- Step 7: Final Video -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                                        <span><i class="fas fa-video"></i> 7. Create Final Video</span>
                                        <span id="step7Progress">0%</span>
                                    </div>
                                    <div class="progress sub-progress">
                                        <div class="progress-bar bg-info" id="step7Bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Batch Directory Info -->
                            <div class="mb-3" id="currentBatchDirectory" style="display: none;">
                                <h6><i class="fas fa-folder"></i> Current Batch Directory</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <code id="currentBatchPath">--</code>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="openCurrentBatchBtn">
                                            <i class="fas fa-folder-open"></i> Open Directory
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output Directory -->
        <div class="row">
            <div class="col-12">
                <div class="card mt-4" id="outputDirectoryCard" style="display: none;">
                    <div class="card-header">
                        <h5><i class="fas fa-folder-open"></i> Output Directory</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Processing output saved to:</strong><br>
                                <code id="outputPath">--</code>
                            </div>
                            <div>
                                <button type="button" class="btn btn-primary" id="openDirectoryBtn">
                                    <i class="fas fa-folder-open"></i> Open in File Explorer
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="copyPathBtn">
                                    <i class="fas fa-copy"></i> Copy Path
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div> <!-- End Processing Tab -->
            
            <!-- Video Stitching Tab Content -->
            <div class="tab-pane fade" id="stitching" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-film"></i> Video Stitching from Incomplete Batches</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Generate final videos from incomplete processing batches using existing intermediate frames.</p>
                                
                                <!-- Batch Directory Input -->
                                <div class="mb-3">
                                    <label class="form-label">Batch Output Directory</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="stitchBatchDir" placeholder="/path/to/output/batch_directory">
                                        <button class="btn btn-outline-secondary" type="button" id="browseBatchBtn">
                                            <i class="fas fa-folder-open"></i> Browse
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Select a directory containing processed frames (e.g., output/video_20250615_143022/)</small>
                                </div>
                                
                                <!-- Batch Analysis -->
                                <div id="batchAnalysis" class="mb-3" style="display: none;">
                                    <h6><i class="fas fa-search"></i> Batch Analysis</h6>
                                    <div class="alert alert-info">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Available Frames:</strong> <span id="availableFrames">--</span><br>
                                                <strong>VR Format:</strong> <span id="detectedFormat">--</span><br>
                                                <strong>Resolution:</strong> <span id="detectedResolution">--</span>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Processing Stage:</strong> <span id="processingStage">--</span><br>
                                                <strong>Audio Available:</strong> <span id="audioAvailable">--</span><br>
                                                <strong>Settings:</strong> <span id="detectedSettings">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stitching Options -->
                                <div id="stitchingOptions" style="display: none;">
                                    <h6><i class="fas fa-cog"></i> Stitching Options</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Frame Source</label>
                                                <select class="form-select" id="frameSource">
                                                    <option value="auto">Auto-detect highest stage</option>
                                                    <option value="vr_frames">Final VR frames (99_vr_frames)</option>
                                                    <option value="left_right_final">Final stereo pairs (6_*_frames_final)</option>
                                                    <option value="left_right_fisheye">Fisheye frames (5_*_frames_fisheye)</option>
                                                    <option value="left_right_basic">Basic stereo pairs (4_*_frames)</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Video Quality</label>
                                                <select class="form-select" id="stitchQuality">
                                                    <option value="high">High (x264 CRF 18)</option>
                                                    <option value="medium" selected>Medium (x264 CRF 23)</option>
                                                    <option value="fast">Fast (x264 CRF 28)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Frame Rate</label>
                                                <select class="form-select" id="stitchFps">
                                                    <option value="original">Original (detected)</option>
                                                    <option value="24">24 fps</option>
                                                    <option value="30">30 fps</option>
                                                    <option value="60">60 fps</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="includeAudio" checked>
                                                    <label class="form-check-label" for="includeAudio">
                                                        Include Original Audio
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Output Settings -->
                                    <div class="mb-3">
                                        <label class="form-label">Output Filename</label>
                                        <input type="text" class="form-control" id="outputFilename" placeholder="custom_video_name.mp4">
                                        <small class="form-text text-muted">Leave empty for auto-generated name based on batch directory</small>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-primary" id="analyzeBatchBtn">
                                        <i class="fas fa-search"></i> Analyze Batch
                                    </button>
                                    <button type="button" class="btn btn-success" id="stitchVideoBtn" style="display: none;">
                                        <i class="fas fa-film"></i> Create Video
                                    </button>
                                </div>
                                
                                <!-- Stitching Progress -->
                                <div id="stitchProgress" class="mt-4" style="display: none;">
                                    <h6><i class="fas fa-spinner fa-spin"></i> Video Creation Progress</h6>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="stitchProgressBar" style="width: 0%"></div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <span id="stitchStatusText">Initializing...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Video Stitching Tab -->
        </div> <!-- End Tab Content -->
    </div>

    <!-- Success/Error Modals -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle"></i> Processing Complete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage">Your video has been processed successfully!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Processing Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">An error occurred during processing.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // Global variables
        let socket;
        let currentSessionId = null;
        let uploadedFilename = null;
        let uploadedOutputDir = null;
        let currentVideoInfo = null;

        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });

            socket.on('progress_update', function(data) {
                updateProgress(data);
            });
            
            socket.on('processing_complete', function(data) {
                handleProcessingComplete(data);
            });
            
            socket.on('processing_error', function(data) {
                handleProcessingError(data);
            });
            
            socket.on('processing_stopped', function(data) {
                handleProcessingStopped(data);
            });
        }

        // Auto-upload video when file is selected
        document.getElementById('videoFile').addEventListener('change', function() {
            const file = this.files[0];

            if (!file) {
                return;
            }

            const formData = new FormData();
            formData.append('video', file);

            const btn = document.getElementById('uploadBtn');
            const btnText = document.getElementById('uploadBtnText');
            btn.style.pointerEvents = 'none';  // Disable during upload
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedFilename = data.filename;
                    uploadedOutputDir = data.output_dir;
                    displayVideoInfo(data.video_info, file);
                    document.getElementById('processBtn').disabled = false;
                    btnText.innerHTML = '<i class="fas fa-check"></i> ' + file.name;
                    // Auto-populate resume field with output directory
                    document.getElementById('resumeDirectory').value = data.output_dir;
                } else {
                    alert('Upload failed: ' + data.error);
                    btnText.textContent = 'Upload Video';
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed');
                btnText.textContent = 'Upload Video';
            })
            .finally(() => {
                btn.style.pointerEvents = '';  // Re-enable
            });
        });

        // Display video info
        function displayVideoInfo(info, file) {
            currentVideoInfo = info;
            
            // Show video preview
            const videoPreview = document.getElementById('videoPreview');
            const video = videoPreview.querySelector('video');
            video.src = URL.createObjectURL(file);
            videoPreview.style.display = 'block';
            
            // Show video info
            document.getElementById('videoResolution').textContent = `${info.width}×${info.height}`;
            document.getElementById('videoAspect').textContent = info.aspect_ratio_text;
            document.getElementById('videoDuration').textContent = `${info.duration}s`;
            document.getElementById('videoFps').textContent = `${info.fps} fps`;
            document.getElementById('videoFrames').textContent = info.frame_count;
            document.getElementById('videoInfo').style.display = 'block';
            
            // Update system info
            updateSystemInfo();

            // Update Step 1 display
            updateStep1Display();

            // Set default end time to video duration only if not already set
            if (!document.getElementById('endTime').value) {
                const minutes = Math.floor(info.duration / 60);
                const seconds = Math.floor(info.duration % 60);
                document.getElementById('endTime').value = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Calculate range info
            updateRangeInfo();
        }

        // Update system information
        function updateSystemInfo() {
            fetch('/system_info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('gpuDevice').textContent = data.gpu_device || '--';
                document.getElementById('vramUsage').textContent = data.vram_usage || '--';
                document.getElementById('deviceMode').textContent = data.device_mode || '--';
            })
            .catch(error => {
                console.error('Failed to load system info:', error);
                document.getElementById('gpuDevice').textContent = '--';
                document.getElementById('vramUsage').textContent = '--';
                document.getElementById('deviceMode').textContent = '--';
            });
        }

        // Update Step 1 display with source and final resolution/FPS
        function updateStep1Display() {
            if (!currentVideoInfo) return;

            // Show source video info
            document.getElementById('step1SourceRes').textContent = `${currentVideoInfo.width}×${currentVideoInfo.height}`;
            document.getElementById('step1SourceFps').textContent = currentVideoInfo.fps;
            document.getElementById('step1SourceInfo').style.display = 'block';

            // Calculate final resolution
            const resolutionSelect = document.getElementById('resolution').value;
            let finalWidth = currentVideoInfo.width;
            let finalHeight = currentVideoInfo.height;

            if (resolutionSelect === '720p') {
                finalWidth = 1280;
                finalHeight = 720;
            } else if (resolutionSelect === '1080p') {
                finalWidth = 1920;
                finalHeight = 1080;
            } else if (resolutionSelect === '4k') {
                finalWidth = 3840;
                finalHeight = 2160;
            }

            // Calculate final FPS
            const fpsSelect = document.getElementById('targetFps').value;
            let finalFps = currentVideoInfo.fps;
            if (fpsSelect !== 'original') {
                finalFps = parseInt(fpsSelect);
            }

            // Update display
            document.getElementById('step1FinalRes').textContent = `${finalWidth}×${finalHeight}`;
            document.getElementById('step1FinalFps').textContent = finalFps;
        }

        // Parse time string to seconds
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr.trim() === '') return null;
            
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                const [minutes, seconds] = parts.map(Number);
                return minutes * 60 + seconds;
            } else if (parts.length === 3) {
                const [hours, minutes, seconds] = parts.map(Number);
                return hours * 3600 + minutes * 60 + seconds;
            }
            return null;
        }

        // Update range information
        function updateRangeInfo() {
            if (!currentVideoInfo) return;
            
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            let startSeconds = timeToSeconds(startTime) || 0;
            let endSeconds = timeToSeconds(endTime) || currentVideoInfo.duration;
            
            // Ensure end is after start
            if (endSeconds <= startSeconds) {
                document.getElementById('rangeInfo').style.display = 'none';
                return;
            }
            
            const duration = endSeconds - startSeconds;
            const targetFps = document.getElementById('targetFps').value;
            const fps = targetFps === 'original' ? currentVideoInfo.fps : parseInt(targetFps);
            const estimatedFrames = Math.round(duration * fps);
            
            // Format duration
            const durationMinutes = Math.floor(duration / 60);
            const durationSeconds = Math.floor(duration % 60);
            const durationStr = `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
            
            document.getElementById('rangeDuration').textContent = durationStr;
            document.getElementById('rangeFrames').textContent = estimatedFrames.toLocaleString();
            document.getElementById('rangeInfo').style.display = 'block';
        }

        // Start processing
        document.getElementById('processBtn').addEventListener('click', function() {
            if (!uploadedFilename) {
                alert('Please upload a video first');
                return;
            }
            
            // Handle custom resolution
            let vrResolution = document.getElementById('vrResolution').value;
            if (vrResolution === 'custom') {
                const customWidth = document.getElementById('customWidth').value;
                const customHeight = document.getElementById('customHeight').value;
                if (customWidth && customHeight) {
                    vrResolution = `custom:${customWidth}x${customHeight}`;
                } else {
                    alert('Please specify both width and height for custom resolution');
                    return;
                }
            }

            const settings = {
                start_time: document.getElementById('startTime').value || null,
                end_time: document.getElementById('endTime').value || null,
                resolution: document.getElementById('resolution').value,
                target_fps: document.getElementById('targetFps').value === 'original' ? null : parseInt(document.getElementById('targetFps').value),
                vr_format: document.getElementById('vrFormat').value,
                vr_resolution: vrResolution,
                baseline: parseFloat(document.getElementById('baseline').value),
                focal_length: parseInt(document.getElementById('focalLength').value),
                preserve_audio: document.getElementById('preserveAudio').checked,
                keep_intermediates: document.getElementById('keepIntermediates').checked,
                video_encoder: document.getElementById('videoEncoder').value,
                device: document.getElementById('device').value,
                model_size: document.getElementById('modelSize').value,
                depth_model_version: document.getElementById('depthModelVersion').value,
                depth_resolution: document.getElementById('depthResolution').value,
                use_metric_depth: document.getElementById('depthModelType').value === 'metric',
                super_sample: document.getElementById('superSample').value,
                apply_distortion: document.getElementById('applyDistortion').checked,
                fisheye_projection: document.getElementById('fisheyeProjection').value,
                fisheye_fov: parseFloat(document.getElementById('fisheyeFov').value),
                crop_factor: document.getElementById('cropFactor') ? parseFloat(document.getElementById('cropFactor').value) : 0.7,
                fisheye_crop_factor: parseFloat(document.getElementById('fisheyeCropFactor').value),
                hole_fill_quality: document.getElementById('holeFillQuality').value,
                experimental_frame_interpolation: document.getElementById('experimentalFrameInterpolation').checked,
                enable_optical_flow: document.getElementById('enableOpticalFlow').checked,
                optical_flow_model: document.getElementById('opticalFlowModel').value,
                optical_flow_blend: parseFloat(document.getElementById('opticalFlowBlend').value) / 100.0,
                optical_flow_detect_occlusions: document.getElementById('opticalFlowDetectOcclusions').checked
            };
            
            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    output_dir: uploadedOutputDir,
                    settings: settings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    socket.emit('join_session', {session_id: currentSessionId});
                    showProgressPanel();
                    showCurrentBatchDirectory(data.output_dir);
                    // Auto-populate resume field for easy resuming
                    document.getElementById('resumeDirectory').value = data.output_dir;
                } else {
                    alert('Failed to start processing: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Processing error:', error);
                alert('Failed to start processing');
            });
        });
        
        // Resume processing
        document.getElementById('resumeBtn').addEventListener('click', function() {
            const resumeDirectory = document.getElementById('resumeDirectory').value.trim();
            
            if (!resumeDirectory) {
                alert('Please enter an output directory to resume');
                return;
            }
            
            fetch('/resume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    output_dir: resumeDirectory
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    socket.emit('join_session', {session_id: currentSessionId});
                    showProgressPanel();
                    showCurrentBatchDirectory(data.output_dir);
                } else {
                    alert('Failed to resume processing: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Resume error:', error);
                alert('Failed to resume processing');
            });
        });
        
        // Stop processing
        document.getElementById('stopBtn').addEventListener('click', function() {
            if (currentSessionId) {
                fetch('/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hideProgressPanel();
                        currentSessionId = null;
                        // Reset progress displays
                        resetProgressDisplay();
                    } else {
                        alert('Failed to stop processing: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Stop error:', error);
                    alert('Failed to stop processing');
                });
            }
        });

        // Reset start time to 00:00
        document.getElementById('resetStartTime').addEventListener('click', function() {
            document.getElementById('startTime').value = '00:00';
            updateRangeInfo();
            saveSettings();
        });

        // Reset end time to video duration
        document.getElementById('resetEndTime').addEventListener('click', function() {
            if (currentVideoInfo) {
                const minutes = Math.floor(currentVideoInfo.duration / 60);
                const seconds = Math.floor(currentVideoInfo.duration % 60);
                document.getElementById('endTime').value = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                updateRangeInfo();
                saveSettings();
            }
        });

        // Show progress panel
        function showProgressPanel() {
            document.querySelector('.progress-container').style.display = 'block';
            document.getElementById('processBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.scrollingElement.scrollTop = document.scrollingElement.scrollHeight;
        }
        
        // Hide progress panel
        function hideProgressPanel() {
            document.querySelector('.progress-container').style.display = 'none';
            document.getElementById('processBtn').style.display = 'inline-block';
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            hideCurrentBatchDirectory();
        }
        
        // Show current batch directory
        function showCurrentBatchDirectory(outputDir) {
            document.getElementById('currentBatchPath').textContent = outputDir;
            document.getElementById('currentBatchDirectory').style.display = 'block';
        }
        
        // Hide current batch directory
        function hideCurrentBatchDirectory() {
            document.getElementById('currentBatchDirectory').style.display = 'none';
        }
        
        // Reset progress display
        function resetProgressDisplay() {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-success', 'bg-danger');
            progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
            
            document.getElementById('progressText').textContent = 'Initializing...';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentFrame').textContent = '0';
            document.getElementById('totalFrames').textContent = '0';
            document.getElementById('processingSpeed').textContent = '--';
            document.getElementById('estimatedTime').textContent = '--';
            
            // Reset sub-progress bars
            document.getElementById('extractProgress').style.width = '0%';
            document.getElementById('depthProgress').style.width = '0%';
            document.getElementById('videoProgress').style.width = '0%';
        }

        // Processing start time for speed calculation
        let processingStartTime = null;
        let lastFrameTime = null;
        let frameProcessingTimes = [];

        // Update progress
        function updateProgress(data) {
            // Update overall progress bar
            const overallBar = document.getElementById('overallProgressBar');
            const overallText = document.getElementById('overallProgressText');
            const overallPhase = document.getElementById('overallProgressPhase');

            if (overallBar) {
                overallBar.style.width = data.progress + '%';
                overallBar.setAttribute('aria-valuenow', data.progress);
            }
            if (overallText) {
                overallText.textContent = data.progress.toFixed(1) + '%';
            }
            if (overallPhase) {
                overallPhase.textContent = data.stage || 'Processing...';
            }

            // Update step-specific progress bars
            updateStepProgress(data);
        }

        // Update individual step progress bars
        function updateStepProgress(data) {
            // Use step_index from backend (0-based, so add 1 for display)
            const stepNum = (data.step_index !== undefined) ? data.step_index + 1 : 1;
            const stepProgress = data.step_progress || 0;
            const stepTotal = data.step_total || 1;
            const stepPercent = stepTotal > 0 ? (stepProgress / stepTotal) * 100 : 0;

            // Mark previous steps as complete (100%)
            for (let i = 1; i <= 7; i++) {
                const bar = document.getElementById(`step${i}Bar`);
                const text = document.getElementById(`step${i}Progress`);

                if (!bar || !text) continue;

                if (i < stepNum) {
                    // Previous steps: 100%
                    bar.style.width = '100%';
                    bar.classList.remove('bg-info');
                    bar.classList.add('bg-success');
                    text.textContent = '100%';
                } else if (i === stepNum) {
                    // Current step: show actual progress
                    bar.style.width = stepPercent + '%';
                    bar.classList.remove('bg-success');
                    bar.classList.add('bg-info');
                    text.textContent = stepPercent.toFixed(0) + '%';
                } else {
                    // Future steps: 0%
                    bar.style.width = '0%';
                    bar.classList.remove('bg-success');
                    bar.classList.add('bg-info');
                    text.textContent = '0%';
                }
            }
        }

        // Handle processing complete
        function handleProcessingComplete(data) {
            const overallBar = document.getElementById('overallProgressBar');
            const overallText = document.getElementById('overallProgressText');
            const overallPhase = document.getElementById('overallProgressPhase');

            if (overallBar) {
                overallBar.style.width = '100%';
                overallBar.classList.remove('progress-bar-animated');
                overallBar.classList.add('bg-success');
            }
            if (overallText) {
                overallText.textContent = '100%';
            }
            if (overallPhase) {
                overallPhase.textContent = 'Complete!';
            }

            // Mark all steps as complete
            for (let i = 1; i <= 7; i++) {
                const bar = document.getElementById(`step${i}Bar`);
                const text = document.getElementById(`step${i}Progress`);
                if (bar && text) {
                    bar.style.width = '100%';
                    bar.classList.add('bg-success');
                    text.textContent = '100%';
                }
            }

            // Hide stop button, show start button
            hideProgressPanel();
            currentSessionId = null;

            // Show output directory card
            document.getElementById('outputPath').textContent = data.output_dir;
            document.getElementById('outputDirectoryCard').style.display = 'block';

            // Show success modal
            document.getElementById('successMessage').textContent = data.message;
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();

            // Reset upload state when modal is dismissed to allow new processing
            document.getElementById('successModal').addEventListener('hidden.bs.modal', function resetAfterComplete() {
                // Reset file input to allow uploading new videos
                const videoFile = document.getElementById('videoFile');
                if (videoFile) {
                    videoFile.value = '';
                }

                // Hide video preview and info
                const videoPreview = document.getElementById('videoPreview');
                const videoInfo = document.getElementById('videoInfo');
                if (videoPreview) videoPreview.style.display = 'none';
                if (videoInfo) videoInfo.style.display = 'none';

                // Reset upload button text
                const uploadBtnText = document.getElementById('uploadBtnText');
                if (uploadBtnText) uploadBtnText.textContent = 'Choose Video File';

                // Remove this event listener to prevent multiple bindings
                this.removeEventListener('hidden.bs.modal', resetAfterComplete);
            }, { once: true });
        }

        // Handle processing error
        function handleProcessingError(data) {
            const overallBar = document.getElementById('overallProgressBar');
            const overallPhase = document.getElementById('overallProgressPhase');

            if (overallBar) {
                overallBar.classList.remove('progress-bar-animated');
                overallBar.classList.remove('bg-success');
                overallBar.classList.add('bg-danger');
            }
            if (overallPhase) {
                overallPhase.textContent = 'Processing failed';
            }

            // Hide stop button, show start button
            hideProgressPanel();
            currentSessionId = null;

            // Show error modal
            document.getElementById('errorMessage').textContent = data.error;
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();

            // Reset upload state when modal is dismissed to allow new processing
            document.getElementById('errorModal').addEventListener('hidden.bs.modal', function resetAfterError() {
                // Reset file input to allow uploading new videos
                const videoFile = document.getElementById('videoFile');
                if (videoFile) {
                    videoFile.value = '';
                }

                // Hide video preview and info
                const videoPreview = document.getElementById('videoPreview');
                const videoInfo = document.getElementById('videoInfo');
                if (videoPreview) videoPreview.style.display = 'none';
                if (videoInfo) videoInfo.style.display = 'none';

                // Reset upload button text
                const uploadBtnText = document.getElementById('uploadBtnText');
                if (uploadBtnText) uploadBtnText.textContent = 'Choose Video File';

                // Remove this event listener to prevent multiple bindings
                this.removeEventListener('hidden.bs.modal', resetAfterError);
            }, { once: true });
        }
        
        // Handle processing stopped
        function handleProcessingStopped(data) {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-warning');
            
            document.getElementById('progressText').textContent = 'Processing stopped';
            
            // Hide stop button, show start button
            hideProgressPanel();
            currentSessionId = null;

            // Show info message
            alert('Processing has been stopped: ' + data.message);

            // Reset upload state to allow new processing
            const videoFile = document.getElementById('videoFile');
            if (videoFile) {
                videoFile.value = '';
            }

            // Hide video preview and info
            const videoPreview = document.getElementById('videoPreview');
            const videoInfo = document.getElementById('videoInfo');
            if (videoPreview) videoPreview.style.display = 'none';
            if (videoInfo) videoInfo.style.display = 'none';

            // Reset upload button text
            const uploadBtnText = document.getElementById('uploadBtnText');
            if (uploadBtnText) uploadBtnText.textContent = 'Choose Video File';
        }


        // Update range info based on video duration and selected range
        function updateRangeInfo() {
            if (!currentVideoInfo) return;
            
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            // Convert time to seconds for calculation
            function timeToSeconds(timeStr) {
                if (!timeStr) return null;
                const parts = timeStr.split(':').map(Number);
                if (parts.length === 2) {
                    return parts[0] * 60 + parts[1]; // mm:ss
                } else if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2]; // hh:mm:ss
                }
                return null;
            }
            
            const startSeconds = timeToSeconds(startTime) || 0;
            const endSeconds = timeToSeconds(endTime) || currentVideoInfo.duration;
            const duration = Math.max(0, endSeconds - startSeconds);
            const frameCount = Math.round(duration * currentVideoInfo.fps);
            
            // Update display elements if they exist
            const rangeInfo = document.getElementById('rangeInfo');
            if (rangeInfo) {
                rangeInfo.textContent = `${duration.toFixed(1)}s (${frameCount} frames)`;
            }
        }


        // Directory operations
        document.getElementById('openCurrentBatchBtn').addEventListener('click', function() {
            const currentBatchPath = document.getElementById('currentBatchPath').textContent;
            if (!currentBatchPath || currentBatchPath === '--' || currentBatchPath.trim() === '') {
                alert('No processing directory available yet. Please start processing first.');
                return;
            }
            fetch('/open_directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({path: currentBatchPath})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Could not open directory: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error opening directory:', error);
                alert('Error opening directory');
            });
        });
        
        document.getElementById('openDirectoryBtn').addEventListener('click', function() {
            const outputPath = document.getElementById('outputPath').textContent;
            if (!outputPath || outputPath === '--' || outputPath.trim() === '') {
                alert('No output directory available yet. Please complete processing first.');
                return;
            }
            fetch('/open_directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({path: outputPath})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Could not open directory: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error opening directory:', error);
                alert('Error opening directory');
            });
        });

        document.getElementById('copyPathBtn').addEventListener('click', function() {
            const outputPath = document.getElementById('outputPath').textContent;
            if (!outputPath || outputPath === '--' || outputPath.trim() === '') {
                alert('No output path available to copy yet. Please complete processing first.');
                return;
            }
            navigator.clipboard.writeText(outputPath).then(() => {
                // Visual feedback
                const btn = document.getElementById('copyPathBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        });

        // Update system info when settings change
        document.getElementById('resolution').addEventListener('change', function() {
            updateSystemInfo();
            updateStep1Display();
        });
        document.getElementById('targetFps').addEventListener('change', function() {
            updateSystemInfo();
            updateRangeInfo();
            updateStep1Display();
        });
        document.getElementById('device').addEventListener('change', updateSystemInfo);

        // Toggle fisheye distortion options
        document.getElementById('applyDistortion').addEventListener('change', function() {
            const distortionOptions = document.getElementById('distortionOptions');
            const distortionK2Options = document.getElementById('distortionK2Options');
            if (this.checked) {
                distortionOptions.style.display = 'block';
                distortionK2Options.style.display = 'block';
            } else {
                distortionOptions.style.display = 'none';
                distortionK2Options.style.display = 'none';
            }
        });

        // Toggle optical flow settings
        document.getElementById('enableOpticalFlow').addEventListener('change', function() {
            const opticalFlowSettings = document.getElementById('opticalFlowSettings');
            if (this.checked) {
                opticalFlowSettings.style.display = 'block';
            } else {
                opticalFlowSettings.style.display = 'none';
            }
        });

        // Update optical flow blend percentage display
        document.getElementById('opticalFlowBlend').addEventListener('input', function() {
            document.getElementById('opticalFlowBlendValue').textContent = this.value + '%';
        });

        // Update range info when time inputs change
        document.getElementById('startTime').addEventListener('input', updateRangeInfo);
        document.getElementById('endTime').addEventListener('input', updateRangeInfo);

        // Video Stitching Tab Functionality
        document.getElementById('analyzeBatchBtn').addEventListener('click', function() {
            const batchDir = document.getElementById('stitchBatchDir').value.trim();
            if (!batchDir) {
                alert('Please enter a batch directory path');
                return;
            }
            
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            fetch('/analyze_batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({batch_dir: batchDir})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayBatchAnalysis(data.analysis);
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                alert('Analysis failed');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Analyze Batch';
            });
        });
        
        function displayBatchAnalysis(analysis) {
            // Show analysis results
            document.getElementById('availableFrames').textContent = analysis.frame_count || '--';
            document.getElementById('detectedFormat').textContent = analysis.vr_format || '--';
            document.getElementById('detectedResolution').textContent = analysis.resolution || '--';
            document.getElementById('processingStage').textContent = analysis.highest_stage || '--';
            document.getElementById('audioAvailable').textContent = analysis.has_audio ? 'Yes' : 'No';
            document.getElementById('detectedSettings').textContent = analysis.settings_summary || '--';
            
            document.getElementById('batchAnalysis').style.display = 'block';
            document.getElementById('stitchingOptions').style.display = 'block';
            document.getElementById('stitchVideoBtn').style.display = 'inline-block';
        }
        
        document.getElementById('stitchVideoBtn').addEventListener('click', function() {
            const batchDir = document.getElementById('stitchBatchDir').value.trim();
            const settings = {
                batch_dir: batchDir,
                frame_source: document.getElementById('frameSource').value,
                quality: document.getElementById('stitchQuality').value,
                fps: document.getElementById('stitchFps').value,
                include_audio: document.getElementById('includeAudio').checked,
                output_filename: document.getElementById('outputFilename').value.trim() || null
            };
            
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Video...';
            
            document.getElementById('stitchProgress').style.display = 'block';
            
            fetch('/stitch_video', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('stitchProgressBar').style.width = '100%';
                    document.getElementById('stitchStatusText').textContent = 'Video created successfully!';
                    setTimeout(() => {
                        alert('Video created: ' + data.output_path);
                        document.getElementById('stitchProgress').style.display = 'none';
                    }, 1000);
                } else {
                    alert('Video creation failed: ' + data.error);
                    document.getElementById('stitchProgress').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Stitching error:', error);
                alert('Video creation failed');
                document.getElementById('stitchProgress').style.display = 'none';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-film"></i> Create Video';
            });
        });
        
        // Browse batch directory button
        document.getElementById('browseBatchBtn').addEventListener('click', function() {
            // For now, just show a hint about common locations
            const outputDirs = [
                'output/',
                './output/',
                '/home/user/workspace/stereo-projector/output/'
            ];
            alert('Common batch directory locations:\n\n' + outputDirs.join('\n') + '\n\nLook for directories with timestamp format like:\nvideo_name_20250615_143022/');
        });

        // Settings persistence functions
        function saveSettings() {
            const SETTINGS_VERSION = 3; // Must match version in loadSettings()
            const settings = {
                version: SETTINGS_VERSION,
                // Time range
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,

                // VR settings
                vrFormat: document.getElementById('vrFormat').value,
                vrResolution: document.getElementById('vrResolution').value,
                baseline: document.getElementById('baseline').value,
                focalLength: document.getElementById('focalLength').value,

                // Video enhancement
                resolution: document.getElementById('resolution').value,
                targetFps: document.getElementById('targetFps').value,
                superSample: document.getElementById('superSample').value,
                device: document.getElementById('device').value,
                modelSize: document.getElementById('modelSize').value,
                depthModelType: document.getElementById('depthModelType').value,

                // Audio and intermediates
                preserveAudio: document.getElementById('preserveAudio').checked,
                keepIntermediates: document.getElementById('keepIntermediates').checked,
                videoEncoder: document.getElementById('videoEncoder').value,

                // Fisheye and cropping
                applyDistortion: document.getElementById('applyDistortion').checked,
                fisheyeProjection: document.getElementById('fisheyeProjection').value,
                fisheyeFov: document.getElementById('fisheyeFov').value,
                cropFactor: document.getElementById('cropFactor').value,
                fisheyeCropFactor: document.getElementById('fisheyeCropFactor').value,
                holeFillQuality: document.getElementById('holeFillQuality').value,

                // Experimental features
                experimentalFrameInterpolation: document.getElementById('experimentalFrameInterpolation').checked,

                // Optical flow
                enableOpticalFlow: document.getElementById('enableOpticalFlow').checked,
                opticalFlowModel: document.getElementById('opticalFlowModel').value,
                opticalFlowBlend: document.getElementById('opticalFlowBlend').value,
                opticalFlowDetectOcclusions: document.getElementById('opticalFlowDetectOcclusions').checked
            };

            localStorage.setItem('stereoProjectorSettings', JSON.stringify(settings));
        }
        
        function loadSettings() {
            const SETTINGS_VERSION = 3; // Increment to force reset of old settings
            const savedSettings = localStorage.getItem('stereoProjectorSettings');
            if (!savedSettings) return;

            try {
                const settings = JSON.parse(savedSettings);

                // Check version and reset if outdated
                if (!settings.version || settings.version < SETTINGS_VERSION) {
                    console.log('Settings version outdated, resetting to new defaults');
                    localStorage.removeItem('stereoProjectorSettings');
                    return; // Will use defaults from HTML
                }

                // Apply settings to form elements
                Object.keys(settings).forEach(key => {
                    if (key === 'version') return; // Skip version metadata
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key];
                        } else {
                            element.value = settings[key];
                        }
                    }
                });

                // Trigger change events for elements that have dependencies
                if (settings.applyDistortion !== undefined) {
                    document.getElementById('applyDistortion').dispatchEvent(new Event('change'));
                }
                if (settings.enableOpticalFlow !== undefined) {
                    document.getElementById('enableOpticalFlow').dispatchEvent(new Event('change'));
                }
                if (settings.opticalFlowBlend !== undefined) {
                    document.getElementById('opticalFlowBlend').dispatchEvent(new Event('input'));
                }

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function resetToDefaults() {
            const defaults = {
                startTime: '',
                endTime: '',
                vrFormat: 'side_by_side',
                vrResolution: 'auto',
                baseline: '0.065',
                focalLength: '1000',
                resolution: 'original',
                targetFps: 'original',
                superSample: 'auto',
                device: 'auto',
                modelSize: 'vitb',
                depthModelType: 'metric',
                processingMode: 'serial',
                preserveAudio: true,
                keepIntermediates: true,
                videoEncoder: 'auto',
                applyDistortion: true,
                fisheyeProjection: 'stereographic',
                fisheyeFov: '180',
                cropFactor: '1.0',
                fisheyeCropFactor: '0.7',
                holeFillQuality: 'fast',
                enableOpticalFlow: false,
                opticalFlowModel: 'auto',
                opticalFlowBlend: '50',
                opticalFlowDetectOcclusions: false
            };

            Object.keys(defaults).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = defaults[key];
                    } else {
                        element.value = defaults[key];
                    }
                }
            });

            // Trigger change events
            document.getElementById('applyDistortion').dispatchEvent(new Event('change'));
            document.getElementById('enableOpticalFlow').dispatchEvent(new Event('change'));
            document.getElementById('opticalFlowBlend').dispatchEvent(new Event('input'));

            // Clear saved settings
            localStorage.removeItem('stereoProjectorSettings');

            alert('Settings reset to defaults');
        }
        
        // Auto-save settings when they change
        function setupAutoSave() {
            const settingsElements = [
                'startTime', 'endTime', 'vrFormat', 'vrResolution', 'baseline', 'focalLength',
                'resolution', 'targetFps', 'superSample', 'device', 'modelSize',
                'depthModelType', 'depthResolution', 'videoEncoder',
                'preserveAudio', 'keepIntermediates', 'applyDistortion', 'fisheyeProjection',
                'fisheyeFov', 'cropFactor', 'fisheyeCropFactor', 'holeFillQuality',
                'experimentalFrameInterpolation', 'enableOpticalFlow', 'opticalFlowModel',
                'opticalFlowBlend', 'opticalFlowDetectOcclusions'
            ];

            settingsElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveSettings);
                    element.addEventListener('input', saveSettings);
                }
            });
        }
        
        // 3D Strength preset functions
        function set3DPreset(preset) {
            const baselineEl = document.getElementById('baseline');
            const focalLengthEl = document.getElementById('focalLength');
            const holeFillEl = document.getElementById('holeFillQuality');
            
            switch(preset) {
                case 'subtle':
                    baselineEl.value = '0.035';
                    focalLengthEl.value = '700';
                    holeFillEl.value = 'fast';
                    break;
                case 'balanced':
                    baselineEl.value = '0.065';
                    focalLengthEl.value = '1000';
                    holeFillEl.value = 'fast';
                    break;
                case 'strong':
                    baselineEl.value = '0.10';
                    focalLengthEl.value = '1200';
                    holeFillEl.value = 'fast';
                    break;
            }
            saveSettings(); // Save the new values
        }

        // Reset settings button
        document.getElementById('resetSettingsBtn').addEventListener('click', function() {
            if (confirm('This will reset all settings to their default values. Are you sure?')) {
                resetToDefaults();
            }
        });

        // Show/hide custom resolution fields
        document.getElementById('vrResolution').addEventListener('change', function() {
            const customDiv = document.getElementById('customResolutionDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            updateSystemInfo();
            loadSettings();
            setupAutoSave();
            
            // Update system info every 5 seconds
            setInterval(updateSystemInfo, 5000);
        });
    </script>
</body>
</html>